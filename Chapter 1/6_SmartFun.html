<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Smart Fun: Math Dash Review</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0fdf4; }
        .game-container { max-width: 600px; background-color: #fff; border: 4px solid #15803d; }
        .question-card { background-color: #ecfdf5; border: 2px solid #34d399; }
        .choice-button { transition: all 0.1s; user-select: none; }
        .choice-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .correct { background-color: #10b981; border-color: #059669; color: white; }
        .wrong { background-color: #ef4444; border-color: #dc2626; color: white; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div id="game-container" class="game-container w-full rounded-xl p-6 md:p-8 text-center shadow-2xl">
        <h1 class="text-3xl font-extrabold text-green-700 mb-4">‚ö° Smart Fun: Math Dash! üèÉ</h1>
        <p class="text-gray-600 mb-6">Answer quickly to keep dashing! Reviewing Numbers 0-20.</p>

        <div id="question-card" class="question-card p-6 rounded-lg mb-8 shadow-md">
            <div class="text-xl font-medium text-gray-700 mb-3">
                Level: <span id="level" class="font-bold text-2xl text-green-600">1</span>
            </div>
            <div id="question-text" class="text-4xl font-black text-gray-900">1 + 1 = ?</div>
        </div>

        <div id="choices-container" class="grid grid-cols-2 gap-4 mb-6"></div>

        <div id="feedback-box" class="h-8 text-xl font-bold text-gray-800"></div>

        <button id="next-button"
                class="mt-4 px-6 py-3 bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600 transition duration-150"
                disabled>Continue Dash</button>
    </div>

    <script>
        let level = 1;
        let correctCount = 0;       // counts correct answers in the current mini-level
        let currentAnswer = 0;
        let gameActive = false;
        let levelPassed = false;    // becomes true once 5 correct answers reached

        const choicesContainer = document.getElementById('choices-container');
        const questionText = document.getElementById('question-text');
        const levelElement = document.getElementById('level');
        const feedbackBox = document.getElementById('feedback-box');
        const nextButton = document.getElementById('next-button');

        function generateQuestion() {
            // If level already passed, do nothing
            if (levelPassed) return { qText: '', answer: null };

            const type = Math.floor(Math.random() * 4);
            let qText = '';
            let answer = 0;

            if (type === 0) {
                const num1 = Math.floor(Math.random() * 10) + 1;
                const num2 = Math.floor(Math.random() * 10) + 1;
                answer = num1 + num2;
                qText = `${num1} + ${num2} = ?`;
            } else if (type === 1) {
                const total = Math.floor(Math.random() * 10) + 10;
                const subtractor = Math.floor(Math.random() * (Math.max(1, total - 5))) + 1;
                answer = total - subtractor;
                qText = `${total} - ${subtractor} = ?`;
            } else if (type === 2) {
                // Tens & Ones question (limit to max 19)
                const tens = 1;  // Only 1 Ten allowed (10)
                const ones = Math.floor(Math.random() * 9) + 1;  // 1‚Äì9
                answer = tens * 10 + ones;   // 11‚Äì19 range
                qText = `${tens} Ten and ${ones} Ones makes what number?`;

            } else {
                const num = Math.floor(Math.random() * 15) + 6; // 6..20
                answer = num;
                const words = ["Six","Seven","Eight","Nine","Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen","Twenty"];
                qText = `Which number is ${words[num - 6]}?`;
            }

            // ensure answer within 0..20 as before
            if (answer < 0) answer = 0;
            if (answer > 20) answer = 20;

            return { qText, answer };
        }

        function renderChoices(choices) {
            choicesContainer.innerHTML = '';
            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'choice-button p-4 bg-yellow-300 text-yellow-900 font-bold text-2xl rounded-lg shadow-xl border-b-4 border-yellow-500';
                btn.textContent = choice;
                btn.dataset.value = choice;
                btn.addEventListener('click', handleChoiceClick);
                choicesContainer.appendChild(btn);
            });
        }

        function setupGame() {
            // if level already passed, freeze UI (don't restart)
            if (levelPassed) return;

            gameActive = true;
            feedbackBox.textContent = '';
            nextButton.disabled = true;

            const { qText, answer } = generateQuestion();
            currentAnswer = answer;
            questionText.innerHTML = qText;
            levelElement.textContent = level;

            // build choices (one correct + 3 decoys)
            let choices = new Set([answer]);
            while (choices.size < 4) {
                let decoy;
                do {
                    decoy = answer + Math.floor(Math.random() * 7) - 3;
                } while (decoy === answer || decoy < 0 || decoy > 20);
                choices.add(decoy);
            }

            const shuffledChoices = Array.from(choices).sort(() => Math.random() - 0.5);
            renderChoices(shuffledChoices);
        }

        function handleChoiceClick(event) {
            if (!gameActive || levelPassed) return;

            gameActive = false;
            const clickedValue = parseInt(event.currentTarget.dataset.value, 10);
            const isCorrect = clickedValue === currentAnswer;

            // mark UI
            document.querySelectorAll('.choice-button').forEach(btn => {
                btn.disabled = true;
                btn.classList.remove('hover:bg-yellow-400');
                if (parseInt(btn.dataset.value, 10) === currentAnswer) {
                    btn.classList.add('correct');
                } else if (parseInt(btn.dataset.value, 10) === clickedValue) {
                    btn.classList.add('wrong');
                }
            });

            if (isCorrect) {
                correctCount++;
                feedbackBox.textContent = `Correct! (${correctCount}/5)`;
                feedbackBox.className = 'mt-4 h-8 text-xl font-bold text-green-600';

                // If reached 5 correct answers -> LEVEL PASSED
                if (correctCount >= 5) {
                    levelPassed = true;          // stop generating further questions
                    feedbackBox.textContent = `üèÜ Level Passed!`;
                    feedbackBox.className = 'mt-4 h-8 text-xl font-bold text-green-600';

                    // Disable all buttons so UI doesn't continue
                    document.querySelectorAll('.choice-button').forEach(btn => btn.disabled = true);

                    // Notify parent/main controller that this level is passed
                    try {
                        window.parent.postMessage({ type: 'levelResult', success: true }, '*');
                    } catch (err) {
                        // ignore if cross-origin or parent not listening
                        console.warn('postMessage failed', err);
                    }

                    // leave nextButton disabled (your main page controls navigation)
                    nextButton.disabled = true;
                    return;
                }

                // not yet passed: allow Next
                nextButton.disabled = false;
                nextButton.textContent = 'Continue Dash';
            } else {
                feedbackBox.textContent = `Wrong! Try again!`;
                feedbackBox.className = 'mt-4 h-8 text-xl font-bold text-red-600';
                nextButton.disabled = false;
                nextButton.textContent = 'Continue Dash';
            }
        }

        nextButton.addEventListener('click', () => {
            // If level passed, do nothing ‚Äî main page should control next steps
            if (levelPassed) return;

            // reset choice button styles & generate next question
            document.querySelectorAll('.choice-button').forEach(btn => {
                btn.classList.remove('correct', 'wrong');
                btn.disabled = false;
            });

            // continue with a new question
            setupGame();
        });

        // initialize first question
        setupGame();
    </script>
</body>
</html>
